# 2026-02-19 개발 일지

#daily #vroong #정산 #일차감

---

## 📊 오늘 작업 요약

| 작업 | 상태 | 분류 |
|------|:----:|------|
| 라이더 주정산 일차감 표시 및 실지급 계산 로직 수정 | ✅ | 백엔드 |
| 선정산배달료 일차감 중복 차감 버그 수정 | ✅ | 백엔드 |
| WORK_DAY 타입 공제 교집합 기간 적용 | ✅ | 백엔드 |
| DAILY 타입 공제 END_DAY 무시 버그 수정 | ✅ | 백엔드 |

---

## 1. 주정산 일차감 표시 및 실지급 계산 로직 수정

> [!info] 배경
> - 선정산에서 일차감이 발생하면 주정산서에 해당 내역이 표시되지 않았음
> - 사용자 요청: 선정산 차감 내역도 주정산서에 동일하게 표시 필요
> - 선정산배달료(PRE_ACCT_VAL)는 **이미 일차감이 차감된 금액**

> [!warning] 문제 1 - 일차감 미표시
> - 기존: `deductAmt = totalDeductAmt - preDeductVal` (차감 후 금액만 표시)
> - 선정산 라이더의 주정산 일차감이 0원으로 표시됨

> [!warning] 문제 2 - 실지급배달료 계산 오류
> - 선정산배달료(235,423원)에 이미 일차감(145,530원)이 차감되어 있음
> - 기존: `totAcctVal = finalDeliveryVal - preAcctVal - actualDeductAmt`
> - 결과: 395,046 - 235,423 - 0 = 159,623원 ❌ (일차감이 반영 안됨)

> [!success] 해결
> - **표시용**: `DEDUCT_AMT = totalDeductAmt` (전체 일차감 금액)
> - **선정산배달료 복원**: `adjustedPreAcctVal = preAcctVal + preDeductVal` (일차감 차감 전으로 복원)
> - **실지급 계산**: `TOT_ACCT_VAL = finalDeliveryVal - adjustedPreAcctVal - actualDeductAmt`
> - 결과: 395,046 - 380,953 - 0 = 14,093원 ✅

> [!tip] 배운 점
> - 선정산배달료(PRE_ACCT_VAL)가 일차감 차감 후 금액임을 인지해야 함
> - 실지급 계산 시 일차감 차감 전 금액으로 복원 필요

### 핵심 이해
```
선정산배달료 = Σ(선정산 TOT_ACCT_VAL) = 235,423원 (일차감 차감 후)
선정산 일차감 = Σ(선정산 DEDUCT_VAL) = 145,530원
선정산배달료(복원) = 235,423 + 145,530 = 380,953원 (일차감 차감 전)
```

### 수정 코드 (RiderSettlementUseCase.java)
```java
// 선정산에서 이미 차감된 일차감 합계 (중복 차감 방지)
BigDecimal preDeductVal = batchData.preDeductValMap.getOrDefault(mapKey, BigDecimal.ZERO);

// 전체 일차감 계산
BigDecimal totalDeductAmt = calculateDeductAmountOptimized(...);

// 실제 차감액 = 전체 일차감 - 선정산에서 이미 차감된 금액
BigDecimal actualDeductAmt = totalDeductAmt.subtract(preDeductVal).max(BigDecimal.ZERO);

// 선정산배달료(preAcctVal)에는 이미 선정산 일차감(preDeductVal)이 차감되어 있음
// 일차감 차감 전 금액으로 복원하여 계산해야 중복 차감 방지됨
BigDecimal adjustedPreAcctVal = preAcctVal.add(preDeductVal);

// 실지급 배달료 = 최종배달료 - 선정산배달료(일차감 차감 전) - 주정산 추가 일차감
BigDecimal totAcctVal = calc.finalDeliveryVal.subtract(adjustedPreAcctVal).subtract(actualDeductAmt);

return RiderSettlement.builder()
    // ...
    .preAcctVal(preAcctVal)           // 표시: 선정산배달료 (일차감 차감 후)
    .deductAmt(totalDeductAmt)        // 표시: 전체 일차감 금액
    .totAcctVal(totAcctVal)           // 계산: 중복 차감 방지된 실지급액
    .build();
```

### 계산 예시 (na35176 라이더)
| 항목 | 값 | 설명 |
|------|-----|------|
| 최종배달료 | 395,046원 | 수수료/보험료/세금 차감 후 |
| 선정산배달료 | 235,423원 | 이미 일차감 차감됨 |
| 선정산 일차감 | 145,530원 | preDeductVal |
| 선정산배달료(복원) | 380,953원 | 235,423 + 145,530 |
| 주정산 추가 일차감 | 0원 | actualDeductAmt |
| **실지급배달료** | **14,093원** | 395,046 - 380,953 - 0 |

---

## 2. DAILY 타입 공제 END_DAY 무시 버그 수정

> [!info] 배경
> - na35176 라이더: 공제 기간 2026-01-29 ~ **2026-02-16**
> - 정산 기간: 2026-02-11 ~ 2026-02-17
> - 교집합: 2026-02-11 ~ 2026-02-16 (**6일**)

> [!warning] 문제
> - `calculateEffectiveDays()`가 계약 이력 기반 값(7일) 반환
> - 공제 END_DAY(2026-02-16)가 무시되어 7일치 차감됨
> - 결과: 169,785원 (24,255 × 7일) - **잘못됨**

> [!success] 해결
> - `calculateEffectiveDays()` 대신 교집합 일수 직접 계산
> - `intersectionDays = ChronoUnit.DAYS.between(effectiveStart, effectiveEnd) + 1`
> - 결과: 145,530원 (24,255 × 6일) - **정상**

### 수정 코드
```java
// 변경 전: 계약 이력 기반 (교집합 무시)
long effectiveDays = calculateEffectiveDays(effectiveStart, effectiveEnd, contEdDate, contractInfo);

// 변경 후: 교집합 기간 직접 계산
long intersectionDays = ChronoUnit.DAYS.between(effectiveStart, effectiveEnd) + 1;
```

---

## 3. WORK_DAY 타입 공제 교집합 기간 적용

> [!info] 배경
> - WORK_DAY 공제: 근무일에만 차감 (배송 완료 건이 있는 날)
> - 공제 기간과 정산 기간의 교집합 내 근무일수만 계산 필요

> [!warning] 문제
> - 기존: 전체 정산 기간의 근무일수 사용 (`workDaysMap`)
> - 공제 기간이 정산 기간보다 짧아도 전체 근무일수로 계산됨

> [!success] 해결
> - 교집합 기간에 대해 `countWorkDays()` 호출
> - `RiderSettlementUseCase.java` 및 `PartnerSettlementUseCase.java` 모두 수정

### 수정 코드
```java
if ("WORK_DAY".equals(deductType)) {
    // 교집합 기간 내 실제 근무일수 조회
    int intersectionWorkDays = vrDeliveryListQueryDslRepository.countWorkDays(
        supplyId, riderId,
        effectiveStart.format(DATE_FORMATTER),
        effectiveEnd.format(DATE_FORMATTER));
    totalDeduct = totalDeduct.add(deductAmt.multiply(BigDecimal.valueOf(intersectionWorkDays)));
}
```

---

## 📁 수정된 파일

| 파일 | 수정 내용 |
|------|----------|
| `RiderSettlementUseCase.java` | 일차감 표시/계산 분리, 선정산배달료 복원 로직, DAILY/WORK_DAY 교집합 적용 |
| `PartnerSettlementUseCase.java` | WORK_DAY 교집합 기간 근무일수 조회 |

---

## 📋 TODO

- [ ] WORK_DAY 타입 공제 테스트 시나리오 작성
- [ ] 정산 기간과 공제 기간 교집합 없는 케이스 엣지 케이스 테스트
- [ ] 선정산 없는 라이더 일차감 정상 작동 확인

---

## 📝 메모

### 일차감 계산 흐름 (최종)
```
1. 공제 기간 ∩ 정산 기간 = 교집합 기간 계산
2. DAILY: 교집합 일수 × 일차감 금액 = totalDeductAmt
3. WORK_DAY: 교집합 기간 내 근무일수 × 일차감 금액 = totalDeductAmt
4. preDeductVal = 선정산에서 이미 차감된 일차감 합계
5. actualDeductAmt = totalDeductAmt - preDeductVal (주정산에서 추가 차감할 금액)
6. adjustedPreAcctVal = preAcctVal + preDeductVal (선정산배달료 복원)
7. totAcctVal = finalDeliveryVal - adjustedPreAcctVal - actualDeductAmt

표시:
- DEDUCT_AMT = totalDeductAmt (전체 일차감)
- PRE_ACCT_VAL = preAcctVal (선정산배달료, 일차감 차감 후)
- TOT_ACCT_VAL = totAcctVal (실지급배달료)
```

### 핵심 포인트
> [!important]
> **선정산배달료(PRE_ACCT_VAL)는 이미 일차감이 차감된 금액이다!**
>
> 따라서 실지급 계산 시 `preDeductVal`을 더해서 일차감 차감 전 금액으로 복원해야 함.

### 테스트 쿼리
```sql
-- 선정산 일차감 합계 확인
SELECT SUM(DEDUCT_VAL) AS pre_deduct_val
FROM vr_rider_acct_daily
WHERE SUPPLY_ID = 'DP2507115380'
  AND RIDER_ID = 'na35176'
  AND ACCT_DATE BETWEEN '20260211' AND '20260217';

-- 선정산배달료 합계 확인
SELECT SUM(TOT_ACCT_VAL) AS pre_acct_val
FROM vr_rider_acct_daily
WHERE SUPPLY_ID = 'DP2507115380'
  AND RIDER_ID = 'na35176'
  AND ACCT_DATE BETWEEN '20260211' AND '20260217';
```
