# 2026-02-10 개발 일지

#daily #vroong

---

## 📊 오늘 작업 요약

| 작업 | 상태 | 분류 |
|------|:----:|------|
| MacroDroid 배민 세션 자동 재인증 | ✅ | Backend |
| 라이더 출금제한 배치 로직 제거 | ✅ | Backend |
| 정산서 중복 업로드 에러 메시지 개선 | ✅ | Backend |
| 프론트엔드 에러 메시지 버그 수정 | ✅ | Frontend |

---

## 1. MacroDroid를 활용한 배민 세션 자동 재인증

> [!info] 배경
> - 배민 셀러 세션이 만료되면 수동으로 로그인 + 2FA 인증 필요
> - relay-server에서 Puppeteer로 자동 로그인 구현했으나, SMS 인증코드 입력이 수동

> [!warning] 문제
> - SMS 인증코드를 사람이 직접 확인해서 API로 전달해야 함
> - 완전 자동화가 안 됨

> [!success] 해결
> - MacroDroid 앱으로 SMS 수신 시 자동으로 서버에 전달
> - SMS 메시지에서 6자리 인증코드 추출: `{lv=auth_code}` 변수 사용
> - GET 방식 웹훅 엔드포인트 추가 (`BaeminAuthController.java`)
> ```
> GET /api/v1/baemin/auth/sms-webhook?message={lv=auth_code}
> ```

> [!check] 결과
> 세션 만료 → 자동 로그인 → SMS 수신 → MacroDroid 자동 전달 → 인증 완료
> **58개 협력사 정상 조회 확인** ✨

> [!tip] 배운 점
> - MacroDroid 같은 자동화 앱으로 모바일-서버 연동 가능
> - GET 방식 엔드포인트가 외부 자동화 도구 연동에 유리

---

## 2. 라이더 개별 출금제한 배치 로직 제거

> [!info] 배경
> 출금제한 처리가 2가지 케이스로 동작 중
> 1. 협력사 잔액 음수 → 협력사 + 소속 라이더 전체 출금제한
> 2. 라이더 개별 잔액 음수 → 해당 라이더만 출금제한

> [!warning] 문제
> - 2번 케이스: 라이더 앱에서 이미 마이너스 잔액이면 출금 버튼 비활성화됨
> - 선정산/주정산으로 잔액이 양수가 되어도 배치 전까지 출금제한 유지

> [!success] 해결
> - `BatchWithdrawalUseCase.java`에서 라이더 개별 출금제한 로직 제거
> - 앱에서 이미 처리하므로 중복 로직 불필요

> [!tip] 배운 점
> - 동일한 기능이 여러 곳에서 처리되면 **타이밍 이슈** 발생 가능
> - 클라이언트에서 이미 처리하는 로직은 서버에서 중복 처리할 필요 없음

---

## 3. 정산서 중복 업로드 에러 메시지 개선

> [!info] 배경
> 같은 정산서를 2번 업로드하면 실패 처리됨

> [!warning] 문제
> - "정산서 업로드에 실패했습니다" 라는 모호한 에러 메시지
> - 사용자가 왜 실패했는지 알 수 없음

> [!success] 해결
> `SettlementUploadUseCase.java` 수정 → 구체적인 메시지 반환
>
> **Before:** `정산서 업로드에 실패했습니다`
> **After:** `20260128 ~ 20260203 정산서를 중복 업로드 하였습니다.`

> [!example]- 코드 보기
> ```java
> private static final DateTimeFormatter PERIOD_FORMATTER =
>     DateTimeFormatter.ofPattern("yyyyMMdd");
>
> private String formatPeriodForMessage(LocalDate startDate, LocalDate endDate) {
>     String start = startDate != null ? startDate.format(PERIOD_FORMATTER) : "알수없음";
>     String end = endDate != null ? endDate.format(PERIOD_FORMATTER) : "알수없음";
>     return start + " ~ " + end;
> }
> ```

---

## 4. 프론트엔드 에러 메시지 미표시 버그 수정

> [!info] 배경
> 백엔드에서 구체적인 에러 메시지를 보내도록 수정 완료

> [!bug] 문제
> 프론트엔드에서 여전히 일반 메시지 표시
> `"라이더 정산서 업로드에 실패했습니다"`

> [!search] 원인 분석
> console.log 디버깅으로 에러 객체 구조 확인:
> ```
> error 전체: {name: 'ApiError', message: '20260128 ~ 20260203...', ...}
> axiosError.response: undefined
> ```
> - axios 인터셉터가 에러를 `ApiError` 객체로 변환
> - 기존 코드는 `error.response.data.message`를 찾음 → `undefined`

> [!success] 해결
> `useSettlementUpload.ts` catch 블록 수정
> ```typescript
> // Before
> const errorMessage = axiosError?.response?.data?.message || '...'
>
> // After
> const errorMessage = apiError?.message || apiError?.response?.data?.message || '...'
> ```

> [!tip] 배운 점
> - axios 인터셉터가 에러를 변환하는 경우, 원본 에러 구조가 달라질 수 있음
> - 디버깅 시 **실제 에러 객체 구조**를 console.log로 확인하는 것이 중요
> - 에러 처리 시 여러 형태의 에러 객체를 고려해야 함

---

## 📋 TODO

- [ ] 변경사항 테스트 완료 후 PR 생성

---

## 📝 메모

- vroong-backend, vroong-front 양쪽 수정 필요했던 작업
- 프론트엔드 에러 처리 시 인터셉터 동작 방식 확인 필수
- MacroDroid 설정: SMS 트리거 → HTTP GET 액션
