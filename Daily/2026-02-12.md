# 2026-02-12 ê°œë°œ ì¼ì§€

#daily #vroong #baemin #dual-session #logout #alb #sms-webhook #auto-reauth

---

## ğŸ“Š ì˜¤ëŠ˜ ì‘ì—… ìš”ì•½

| ì‘ì—…                                | ìƒíƒœ  | ë¶„ë¥˜           |
| --------------------------------- | :-: | ------------ |
| relay-server ì½”ë“œ ë³µì› (ìë™ ë¡œê·¸ì¸ ì„±ê³µ ì‹œì ) |  âœ…  | Rollback     |
| ì„œë²„ ë°°í¬ ì‹œ ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ ì¶”ê°€                |  âœ…  | Feature      |
| ë“€ì–¼ ì„¸ì…˜ ë§¤ë‹ˆì € í†µí•©                      |  âœ…  | Feature      |
| SMS ì›¹í›… URL ë¬¸ì œ í•´ê²°                  |  âœ…  | Bug Fix      |
| ALB 8090 í¬íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€                |  âœ…  | Infra        |
| ë“€ì–¼ ì„¸ì…˜ ì™„ì „ ë™ì‘ í™•ì¸                    |  âœ…  | Verification |

---

## 1. relay-server ì½”ë“œ ë³µì›

> [!info] ë°°ê²½
> - ì–´ì œ ìˆ˜ì •í•œ ì½”ë“œë“¤ì´ ì—¬ëŸ¬ ë¬¸ì œë¥¼ ì¼ìœ¼í‚´
> - ìë™ ì¬ì¸ì¦ ì„±ê³µí–ˆë˜ ì‹œì ìœ¼ë¡œ ë˜ëŒë¦¬ê¸° í•„ìš”

> [!success] í•´ê²°
> - git ì»¤ë°‹ `f89d6c7 ìë™ ë¡œê·¸ì¸ ì„±ê³µ ì‹œì `ìœ¼ë¡œ ë³µì›
> - ëª…ë ¹ì–´: `git checkout f89d6c7 -- relay-server/`
> - relay-server í´ë”ë§Œ ì„ íƒì ìœ¼ë¡œ ë³µì›

> [!tip] ë°°ìš´ ì 
> - git checkoutìœ¼ë¡œ íŠ¹ì • í´ë”ë§Œ ê³¼ê±° ì»¤ë°‹ìœ¼ë¡œ ë³µì› ê°€ëŠ¥
> - ë³µì› í›„ ìŠ¤í…Œì´ì§• í•´ì œ: `git restore --staged relay-server/`

---

## 2. ì„œë²„ ë°°í¬ ì‹œ ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ ì¶”ê°€

> [!info] ë°°ê²½
> - ECS ì„œë¹„ìŠ¤ ì¬ë°°í¬ ì‹œ ê¸°ì¡´ ì„¸ì…˜ì´ ì‚´ì•„ìˆìœ¼ë©´ ì¶©ëŒ ê°€ëŠ¥
> - ìƒˆ ë°°í¬ ì‹œ ê¸°ì¡´ ì„¸ì…˜ì„ ì •ë¦¬í•˜ê³  ìƒˆë¡œ ë¡œê·¸ì¸í•´ì•¼ í•¨

> [!warning] ë¬¸ì œ
> - ë°°í¬ í›„ ì„¸ì…˜ ìƒíƒœê°€ ë¶ˆì¼ì¹˜í•  ìˆ˜ ìˆìŒ
> - ì´ì „ ì„¸ì…˜ ì¿ í‚¤ê°€ ë¬´íš¨í™”ë˜ì–´ API í˜¸ì¶œ ì‹¤íŒ¨

> [!success] í•´ê²°
> - `logout()` í•¨ìˆ˜ ì¶”ê°€ (`services/baemin/auth.js`)
> - ë°°ë¯¼ ë¡œê·¸ì•„ì›ƒ API í˜¸ì¶œ: `POST https://api-deliverycenter.baemin.com/logout`
> - ì„œë²„ ì‹œì‘ ì‹œ ê¸°ì¡´ ì„¸ì…˜ ë¡œê·¸ì•„ì›ƒ í›„ ì¬ì¸ì¦ ì‹œì‘

### ìˆ˜ì •ëœ íŒŒì¼
```
relay-server/services/baemin/auth.js      - logout() í•¨ìˆ˜ ì¶”ê°€
relay-server/services/baemin/constants.js - BAEMIN_API.LOGOUT URL ì¶”ê°€
relay-server/services/baemin/index.js     - logout export ì¶”ê°€
relay-server/server.js                    - ì„œë²„ ì‹œì‘ ì‹œ ë¡œê·¸ì•„ì›ƒ ë¡œì§
```

### ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
```javascript
async function logout(session) {
    const page = browserManager.getPage(sessionId);

    // í˜ì´ì§€ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¡œê·¸ì•„ì›ƒ API í˜¸ì¶œ
    const logoutResult = await page.evaluate(async (logoutUrl, centerId) => {
        const response = await fetch(logoutUrl, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'center-id': centerId || '',
            }
        });
        return { success: response.ok };
    }, BAEMIN_API.LOGOUT, centerId);

    // ì„¸ì…˜ ì‚­ì œ
    await browserManager.destroySession(sessionId);
}
```

---

## 3. ë“€ì–¼ ì„¸ì…˜ ë§¤ë‹ˆì € í†µí•©

> [!info] ë°°ê²½
> - í•˜ë‚˜ì˜ ì„¸ì…˜ì´ ë§Œë£Œë˜ë©´ ë°°ì¹˜ ì‘ì—…ì´ ì¤‘ë‹¨ë¨
> - ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤ë¥¼ ìœ„í•´ ë°±ì—… ì„¸ì…˜ í•„ìš”

> [!success] í•´ê²°
> - ê¸°ì¡´ `dual-session-manager.js` í™œìš©
> - `server.js`ì— í†µí•© ë° API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€

### ë“€ì–¼ ì„¸ì…˜ êµ¬ì¡°
```
Primary ì„¸ì…˜ (í™œì„±)  â† ëª¨ë“  API ìš”ì²­ ì²˜ë¦¬
    â†“ ë§Œë£Œ ê°ì§€
Backup ì„¸ì…˜ (ëŒ€ê¸°)  â†’ Primaryë¡œ ìŠ¹ê²©
    â†“
ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìƒˆ Backup ìƒì„± (30ì´ˆ í›„)
    â†“
ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤ ìœ ì§€!
```

### ì¶”ê°€ëœ API ì—”ë“œí¬ì¸íŠ¸
| ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… |
|-----------|------|
| `GET /relay/dual-session/status` | Primary/Backup ì„¸ì…˜ ìƒíƒœ |
| `GET /relay/dual-session/active` | í˜„ì¬ í™œì„± ì„¸ì…˜ ID |
| `POST /relay/dual-session/start` | ë“€ì–¼ ì„¸ì…˜ ìˆ˜ë™ ì‹œì‘ |
| `POST /relay/dual-session/failover` | ìˆ˜ë™ í˜ì¼ì˜¤ë²„ (í…ŒìŠ¤íŠ¸ìš©) |
| `POST /relay/dual-session/stop` | ë“€ì–¼ ì„¸ì…˜ ì •ì§€ |

---

## 4. SMS ì›¹í›… URL ë¬¸ì œ í•´ê²°

> [!info] ë°°ê²½
> - MacroDroid ì•±ì—ì„œ SMS ì›¹í›… ì „ì†¡ ì‹œ 200 ì‘ë‹µì„ ë°›ì§€ë§Œ
> - relay-serverì—ì„œ `[SMS ì›¹í›…]` ë¡œê·¸ê°€ ì°íˆì§€ ì•ŠìŒ

> [!warning] ë¬¸ì œ
> - ë§¤í¬ë¡œ ì•± URL: `http://vroong-alb:8080/api/v1/baemin/auth/sms-webhook`
> - relay-server ì—”ë“œí¬ì¸íŠ¸: `/webhook/sms`
> - **ì™„ì „íˆ ë‹¤ë¥¸ ê²½ë¡œë¡œ ìš”ì²­ ì¤‘!**
> - 8080 í¬íŠ¸ëŠ” Spring Boot ë°±ì—”ë“œë¡œ ì—°ê²°ë¨

> [!success] í•´ê²°
> - ë§¤í¬ë¡œ ì•± URL ë³€ê²½: `http://vroong-alb:8090/webhook/sms`
> - ALBì— 8090 í¬íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì•„ë˜ ì°¸ì¡°)

---

## 5. ALB 8090 í¬íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€

> [!info] ë°°ê²½
> - relay-serverëŠ” 8090 í¬íŠ¸ì—ì„œ ì‹¤í–‰
> - ê¸°ì¡´ vroong-albëŠ” 8080(dev), 443(prod)ë§Œ ë¦¬ìŠ¤ë‹

> [!warning] ë¬¸ì œ
> 1. ALBì— 8090 ë¦¬ìŠ¤ë„ˆ ì—†ìŒ â†’ 504 Gateway Timeout
> 2. ALB ë³´ì•ˆ ê·¸ë£¹ì— 8090 ì¸ë°”ìš´ë“œ ì—†ìŒ
> 3. ECS ë³´ì•ˆ ê·¸ë£¹ì— ALBâ†’8090 í—ˆìš© ì—†ìŒ
> 4. ALB ê°€ìš© ì˜ì—­(2a, 2b)ê³¼ ECS ê°€ìš© ì˜ì—­(2a~2d) ë¶ˆì¼ì¹˜ â†’ 503 Service Unavailable

> [!success] í•´ê²°

### Step 1: íƒ€ê²Ÿ ê·¸ë£¹ ìƒì„±
- ì´ë¦„: `vroong-relay-tg-dev`
- íƒ€ì…: IP addresses
- í¬íŠ¸: 8090
- Health check: `/health`

### Step 2: ALB ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
- Protocol: HTTP
- Port: 8090
- Target group: `vroong-relay-tg-dev`

### Step 3: ECS ì„œë¹„ìŠ¤ì— íƒ€ê²Ÿ ê·¸ë£¹ ì—°ê²°
- Load balancer: `vroong-alb`
- Listener: `8090:HTTP`
- Container: `relay:8090`

### Step 4: ë³´ì•ˆ ê·¸ë£¹ ì„¤ì •
```
# ALB ë³´ì•ˆ ê·¸ë£¹ (sg-023cedb908b4ac876)
Inbound: 8090 from 0.0.0.0/0

# ECS íƒœìŠ¤í¬ ë³´ì•ˆ ê·¸ë£¹ (sg-0a402d0b95bd18188)
Inbound: 8090 from sg-023cedb908b4ac876 (ALB)
```

### Step 5: ALB ê°€ìš© ì˜ì—­ ì¶”ê°€
```
ê¸°ì¡´: ap-northeast-2a, ap-northeast-2b
ì¶”ê°€: ap-northeast-2c (subnet-01ee3b942b61ba20c)
      ap-northeast-2d (subnet-09ecf54372be7116e)
```

> [!tip] ë°°ìš´ ì 
> - ALBì™€ ECS íƒœìŠ¤í¬ì˜ ê°€ìš© ì˜ì—­ì´ ì¼ì¹˜í•´ì•¼ í•¨
> - ë¶ˆì¼ì¹˜ ì‹œ "Target is in an Availability Zone that is not enabled for the load balancer" ì—ëŸ¬

---

## 6. ë“€ì–¼ ì„¸ì…˜ ë™ì‘ í™•ì¸

> [!success] ìµœì¢… ê²°ê³¼

### ë¡œê·¸ í™•ì¸
```
[10:16:44] [DualSession] ë“€ì–¼ ì„¸ì…˜ ì‹œì‘
[10:17:31] [SMS ì›¹í›…] ë‚´ìš©: 024561
[10:17:38] [DualSession] Primary ì„¸ì…˜ ìƒì„± ì™„ë£Œ: 97714636...
[10:18:08] [DualSession] Backup ì„¸ì…˜ ìƒì„± ì¤‘...
[10:19:01] [SMS ì›¹í›…] ë‚´ìš©: 572701
[10:19:08] [DualSession] Backup ì„¸ì…˜ ìƒì„± ì™„ë£Œ: b0400b1b...
[10:19:08] [DualSession] ë“€ì–¼ ì„¸ì…˜ ì‹œì‘ ì„±ê³µ!
[10:19:08] [DualSession] Primary: 97714636
[10:19:08] [DualSession] Backup: b0400b1b
```

### í™•ì¸ëœ ê¸°ëŠ¥
- âœ… SMS ì›¹í›…: MacroDroid â†’ ALB:8090 â†’ relay-server ì •ìƒ ì—°ê²°
- âœ… ìë™ ë¡œê·¸ì¸: ID/PW ì…ë ¥ â†’ 2FA ìë™ ì²˜ë¦¬
- âœ… ë“€ì–¼ ì„¸ì…˜: Primary + Backup ë‘ ì„¸ì…˜ ìƒì„±
- âœ… í—¬ìŠ¤ì²´í¬: 60ì´ˆ ê°„ê²©ìœ¼ë¡œ ì„¸ì…˜ ìƒíƒœ ëª¨ë‹ˆí„°ë§
- âœ… í˜‘ë ¥ì‚¬ ì¡°íšŒ: 58ê°œ í˜‘ë ¥ì‚¬ ì •ìƒ ë¡œë“œ

---

## ğŸ“‹ TODO

- [x] relay-server ë³µì› (ìë™ ë¡œê·¸ì¸ ì„±ê³µ ì‹œì )
- [x] ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ ì¶”ê°€
- [x] ë“€ì–¼ ì„¸ì…˜ í†µí•©
- [x] SMS ì›¹í›… ë¬¸ì œ í•´ê²°
- [x] ALB ì„¤ì • ì™„ë£Œ
- [x] ë“€ì–¼ ì„¸ì…˜ ë™ì‘ í™•ì¸

---

## ğŸ“ ë©”ëª¨

### ë§¤í¬ë¡œ ì•± ì„¤ì • (ë³€ê²½ë¨)
```
URL: http://vroong-alb-1049542169.ap-northeast-2.elb.amazonaws.com:8090/webhook/sms
Method: POST
Body: {"message": "{lv=auth_code}"}
Headers:
  Content-Type: application/json
```

### ECS í™˜ê²½ë³€ìˆ˜ (í•„ìˆ˜)
```
USE_PUPPETEER=true
BAEMIN_USERNAME=xxx
BAEMIN_PASSWORD=xxx
BAEMIN_PHONE=010xxxxxxxx
AWS_REDIS_URL=redis://your-redis:6379
```

### ë°°í¬ ëª…ë ¹ì–´
```bash
# 1. ECR ë¡œê·¸ì¸
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 151567229571.dkr.ecr.ap-northeast-2.amazonaws.com

# 2. Docker ë¹Œë“œ
docker build -f Dockerfile.puppeteer -t vroong/relay:dev .

# 3. íƒœê·¸
docker tag vroong/relay:dev 151567229571.dkr.ecr.ap-northeast-2.amazonaws.com/vroong/relay:dev

# 4. í‘¸ì‹œ
docker push 151567229571.dkr.ecr.ap-northeast-2.amazonaws.com/vroong/relay:dev

# 5. ECS ì¬ë°°í¬
aws ecs update-service --cluster vroong-cluster --service vroong-relay-service-dev --force-new-deployment --region ap-northeast-2
```

### AWS ë¦¬ì†ŒìŠ¤ ì •ë¦¬
```
ALB: vroong-alb
  - Listener 8090 â†’ vroong-relay-tg-dev

Target Group: vroong-relay-tg-dev
  - Port: 8090
  - Health: /health

ECS Service: vroong-relay-service-dev
  - Task Definition: vroong-relay-task-dev
  - Container Port: 8090

Security Groups:
  - ALB: sg-023cedb908b4ac876 (inbound 8090)
  - ECS: sg-0a402d0b95bd18188 (inbound 8090 from ALB)
```

### ìˆ˜ì •ëœ íŒŒì¼ (Relay Server)
```
relay-server/server.js                    - ë“€ì–¼ ì„¸ì…˜ í†µí•©, API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
relay-server/services/auto-reauth.js      - ë³µì›
relay-server/services/baemin/auth.js      - logout() í•¨ìˆ˜ ì¶”ê°€, ë³µì›
relay-server/services/baemin/constants.js - BAEMIN_API.LOGOUT ì¶”ê°€
relay-server/services/baemin/index.js     - logout export
relay-server/services/baemin/center.js    - ë³µì›
relay-server/services/browser/core.js     - ë³µì›
```
