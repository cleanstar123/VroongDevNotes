# 2026-02-13 ê°œë°œ ì¼ì§€

#daily #vroong #baemin #dual-session #auto-reauth #sms-buffer #session-fallback #email-alert

---

## ğŸ“Š ì˜¤ëŠ˜ ì‘ì—… ìš”ì•½

| ì‘ì—… | ìƒíƒœ | ë¶„ë¥˜ |
|------|:----:|------|
| SMS íƒ€ì´ë° ë¬¸ì œ í•´ê²° (ë²„í¼ë§) | âœ… | Bug Fix |
| ì„¸ì…˜ Fallback ë¡œì§ ì¶”ê°€ | âœ… | Feature |
| ì´ë©”ì¼ ë°œì†¡ ë¡œì§ ìµœì í™” | âœ… | Improvement |

---

## 1. SMS íƒ€ì´ë° ë¬¸ì œ í•´ê²°

> [!info] ë°°ê²½
> - ì„¸ì…˜ ì¬ì¸ì¦ ì‹œ SMS ì¸ì¦ì½”ë“œê°€ `_waitForSMS()` Promise ì„¤ì • ì „ì— ë¨¼ì € ë„ì°©í•˜ëŠ” ê²½ìš° ë°œìƒ
> - ë¡œê·¸ì—ì„œ "SMS ìˆ˜ì‹ í–ˆìœ¼ë‚˜ ëŒ€ê¸° ì¤‘ì¸ ì¬ì¸ì¦ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ" ì˜¤ë¥˜ í™•ì¸

> [!warning] ë¬¸ì œ
> ```
> 08:31:27 - [Puppeteer] ì¸ì¦ë²ˆí˜¸ ë°›ê¸° ë²„íŠ¼ í´ë¦­ ì™„ë£Œ
> 08:31:28 - [SMS ì›¹í›…] ë‚´ìš©: 751539
> 08:31:28 - [AutoReauth] SMS ìˆ˜ì‹ í–ˆìœ¼ë‚˜ ëŒ€ê¸° ì¤‘ì¸ ì¬ì¸ì¦ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ â† ì‹¤íŒ¨!
> 08:31:29 - [AutoReauth] 2FA ì½”ë“œ ìš”ì²­ ì™„ë£Œ - SMS ëŒ€ê¸° ì¤‘... â† ëŠ¦ìŒ!
> ```
> - SMSê°€ 1ì´ˆ ë¨¼ì € ë„ì°©í•˜ì—¬ Promiseê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì€ ìƒíƒœ
> - ê²°ê³¼ì ìœ¼ë¡œ SMS ëŒ€ê¸° íƒ€ì„ì•„ì›ƒ (2ë¶„) ë°œìƒ

> [!success] í•´ê²°
> - SMS ë²„í¼ë§ ë¡œì§ ì¶”ê°€: SMSê°€ ë¨¼ì € ë„ì°©í•˜ë©´ ë²„í¼ì— ì €ì¥
> - `_waitForSMS()` í˜¸ì¶œ ì‹œ ë²„í¼ì— ìœ íš¨í•œ SMSê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‚¬ìš©

### ìˆ˜ì • ì½”ë“œ (`auto-reauth.js`)

```javascript
// ìƒì„±ìì— ë²„í¼ ë³€ìˆ˜ ì¶”ê°€
this.smsBuffer = null;
this.smsBufferTimestamp = null;
this.smsBufferMaxAge = 30000;  // ë²„í¼ ìœ íš¨ê¸°ê°„ 30ì´ˆ

// receiveSMS(): SMSê°€ ë¨¼ì € ë„ì°©í•˜ë©´ ë²„í¼ì— ì €ì¥
receiveSMS(smsText) {
    const code = smsText.match(/(\d{6})/)?.[1];

    // ëŒ€ê¸° ì¤‘ì¸ Promiseê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ resolve
    if (this.smsResolve) {
        this.smsResolve(code);
        return { success: true, code };
    }

    // ì¬ì¸ì¦ ì§„í–‰ ì¤‘ì´ë©´ ë²„í¼ì— ì €ì¥ (íƒ€ì´ë° ë¬¸ì œ í•´ê²°)
    if (this.reauthState.isInProgress) {
        console.log('[AutoReauth] ì¬ì¸ì¦ ì§„í–‰ ì¤‘ - SMSë¥¼ ë²„í¼ì— ì €ì¥');
        this.smsBuffer = code;
        this.smsBufferTimestamp = Date.now();
        return { success: true, code, buffered: true };
    }

    return { success: false, error: 'ëŒ€ê¸° ì¤‘ì¸ ì¬ì¸ì¦ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ' };
}

// _waitForSMS(): ë²„í¼ì— SMSê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‚¬ìš©
_waitForSMS() {
    // ë²„í¼ì— ìœ íš¨í•œ SMSê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ë°˜í™˜
    if (this.smsBuffer && this.smsBufferTimestamp) {
        const bufferAge = Date.now() - this.smsBufferTimestamp;
        if (bufferAge < this.smsBufferMaxAge) {
            const code = this.smsBuffer;
            console.log(`[AutoReauth] ë²„í¼ì—ì„œ SMS ì½”ë“œ ì‚¬ìš©: ${code} (${bufferAge}ms ì „ ë„ì°©)`);
            this.smsBuffer = null;
            return Promise.resolve(code);
        }
    }

    return new Promise((resolve, reject) => {
        // ê¸°ì¡´ ë¡œì§...
    });
}
```

### ìˆ˜ì • í›„ ì˜ˆìƒ ë¡œê·¸
```
[AutoReauth] ì¬ì¸ì¦ ì§„í–‰ ì¤‘ - SMSë¥¼ ë²„í¼ì— ì €ì¥
[AutoReauth] ë²„í¼ì—ì„œ SMS ì½”ë“œ ì‚¬ìš©: 751539 (1200ms ì „ ë„ì°©)
[AutoReauth] Step 3: SMS ìˆ˜ì‹  ì™„ë£Œ - ì½”ë“œ: 751539
```

---

## 2. ì„¸ì…˜ Fallback ë¡œì§ ì¶”ê°€

> [!info] ë°°ê²½
> - ë°°ì¹˜ ì‘ì—…ì´ íŠ¹ì • sessionIdë¡œ API ìš”ì²­
> - í•´ë‹¹ ì„¸ì…˜ì´ ë§Œë£Œë˜ë©´ 404 ì˜¤ë¥˜ â†’ ë°°ì¹˜ ì‹¤íŒ¨
> - í•˜ì§€ë§Œ DualSessionì˜ í™œì„± ì„¸ì…˜ì€ ì‚´ì•„ìˆìŒ

> [!warning] ë¬¸ì œ
> ```
> ë°°ì¹˜ ìš”ì²­: sessionId=abc12345 (ë§Œë£Œë¨)
>     â†“
> getSessionFromRedis("abc12345") â†’ null
>     â†“
> 404 ì˜¤ë¥˜ ë°˜í™˜ â†’ ë°°ì¹˜ ì‹¤íŒ¨!
>     â†“
> í™œì„± ì„¸ì…˜(25725d7c)ì€ ë©€ì©¡í•œë° ì‚¬ìš© ëª»í•¨
> ```

> [!success] í•´ê²°
> - `getSessionFromRedis()` í•¨ìˆ˜ì— ìë™ Fallback ë¡œì§ ì¶”ê°€
> - ìš”ì²­í•œ ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ â†’ DualSessionManagerì˜ í™œì„± ì„¸ì…˜ìœ¼ë¡œ ìë™ ì „í™˜

### ìˆ˜ì • ì½”ë“œ (`server.js`)

```javascript
async function getSessionFromRedis(sessionId, options = {}) {
    const { skipFallback = false } = options;

    if (USE_PUPPETEER) {
        // 1. ìš”ì²­ëœ sessionIdë¡œ ì„¸ì…˜ ì¡°íšŒ
        if (sessionId) {
            const browserSession = browserManager.getSession(sessionId);
            if (browserSession && browserSession.loginStatus === 'AUTHENTICATED') {
                return { sessionId, ...browserSession, isPuppeteerMode: true };
            }
        }

        // 2. ìš”ì²­ ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ í™œì„± ì„¸ì…˜ìœ¼ë¡œ Fallback (ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤)
        if (!skipFallback && dualSessionManager.state.isInitialized) {
            const activeSession = await dualSessionManager.getActiveSession();
            if (activeSession && activeSession.sessionId) {
                const requestedShort = sessionId ? sessionId.substring(0, 8) : 'none';
                const activeShort = activeSession.sessionId.substring(0, 8);

                if (!sessionId || sessionId !== activeSession.sessionId) {
                    console.log(`[Session Fallback] ìš”ì²­ ì„¸ì…˜(${requestedShort}) â†’ í™œì„± ì„¸ì…˜(${activeShort}) ìë™ ì „í™˜`);
                }

                return {
                    sessionId: activeSession.sessionId,
                    ...activeSession.session,
                    isPuppeteerMode: true,
                    fallbackUsed: true
                };
            }
        }

        // 3. Fallbackë„ ì‹¤íŒ¨í•˜ë©´ null
        return null;
    }

    // ê¸°ì¡´ Redis ëª¨ë“œ...
}
```

### ìˆ˜ì • í›„ ë™ì‘ íë¦„
```
ë°°ì¹˜ ìš”ì²­: sessionId=abc12345 (ë§Œë£Œë¨)
    â†“
getSessionFromRedis("abc12345") â†’ ì„¸ì…˜ ì—†ìŒ
    â†“
[Session Fallback] ìš”ì²­ ì„¸ì…˜(abc12345) â†’ í™œì„± ì„¸ì…˜(25725d7c) ìë™ ì „í™˜
    â†“
í™œì„± ì„¸ì…˜ìœ¼ë¡œ API ì²˜ë¦¬ â†’ ì„±ê³µ!
    â†“
ë°°ì¹˜ ê³„ì† ì§„í–‰ (ë¬´ì¤‘ë‹¨)
```

---

## 3. ì´ë©”ì¼ ë°œì†¡ ë¡œì§ ìµœì í™”

> [!info] ë°°ê²½
> - ì´ì „: ì„¸ì…˜ ë§Œë£Œ ê°ì§€ ì¦‰ì‹œ ì´ë©”ì¼ ë°œì†¡
> - ë¬¸ì œ: Fallback/ìë™ ì¬ì¸ì¦ ì„±ê³µí•´ë„ ì´ë¯¸ ì´ë©”ì¼ ë°œì†¡ë¨
> - ë¶ˆí•„ìš”í•œ ì•Œë¦¼ìœ¼ë¡œ ì¸í•´ ì‹¤ì œ ë¬¸ì œ íŒŒì•… ì–´ë ¤ì›€

> [!warning] ë¬¸ì œ (ê¸°ì¡´ íë¦„)
> ```
> ì„¸ì…˜ ë§Œë£Œ â†’ ì´ë©”ì¼ ë°œì†¡ (1ì°¨)
>          â†’ Failover ì„±ê³µ â†’ ì´ë©”ì¼ ë°œì†¡ (2ì°¨)
>          â†’ ì„œë¹„ìŠ¤ ì •ìƒì¸ë° ì´ë©”ì¼ 2í†µ ìˆ˜ì‹ 
> ```

> [!success] í•´ê²°
> - ì´ë©”ì¼ì€ **ìë™ ì¬ì¸ì¦ê¹Œì§€ ëª¨ë‘ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ** ë°œì†¡
> - Failover ì„±ê³µ ì‹œì—ëŠ” ì´ë©”ì¼ ë°œì†¡í•˜ì§€ ì•ŠìŒ

### ë³€ê²½ ë‚´ì—­

| ìœ„ì¹˜ | ìˆ˜ì • ì „ | ìˆ˜ì • í›„ |
|------|---------|---------|
| `keepSessionAlive()` 1630ì¤„ | ì´ë©”ì¼ ë°œì†¡ | ~~ì œê±°~~ |
| `keepSessionAlive()` 1669ì¤„ | ì´ë©”ì¼ ë°œì†¡ | ~~ì œê±°~~ |
| `failover` ì´ë²¤íŠ¸ 2043ì¤„ | ì´ë©”ì¼ ë°œì†¡ | ~~ì œê±°~~ |
| `reauthFailed` ì´ë²¤íŠ¸ 2022ì¤„ | ì´ë©”ì¼ ë°œì†¡ | âœ… ìœ ì§€ (ìµœì¢… ì‹¤íŒ¨) |

### ìˆ˜ì • í›„ ì´ë©”ì¼ ë°œì†¡ íë¦„
```
ì„¸ì…˜ ë§Œë£Œ ê°ì§€
    â†“
Failover ì‹œë„ (Backup â†’ Primary ìŠ¹ê²©)
    â†“ ì„±ê³µ: ì„œë¹„ìŠ¤ ê³„ì†, ì´ë©”ì¼ ì—†ìŒ
    â†“ ì‹¤íŒ¨:
ìë™ ì¬ì¸ì¦ ì‹œë„
    â†“ ì„±ê³µ: ì„œë¹„ìŠ¤ ê³„ì†, ì´ë©”ì¼ ì—†ìŒ
    â†“ ì‹¤íŒ¨:
ì´ë©”ì¼ ë°œì†¡ âš ï¸ (ìµœì¢… ì‹¤íŒ¨ ì‹œì—ë§Œ!)
```

> [!tip] ë°°ìš´ ì 
> - ìë™ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜ì´ ìˆì„ ë•ŒëŠ” ìµœì¢… ì‹¤íŒ¨ ì‹œì—ë§Œ ì•Œë¦¼ ë°œì†¡
> - ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ mail-serviceì— 10ë¶„ ì¿¨ë‹¤ìš´ ì„¤ì • í™œìš©

---

## ğŸ“‹ TODO

- [x] SMS íƒ€ì´ë° ë¬¸ì œ í•´ê²° (ë²„í¼ë§)
- [x] ì„¸ì…˜ Fallback ë¡œì§ ì¶”ê°€
- [x] ì´ë©”ì¼ ë°œì†¡ ë¡œì§ ìµœì í™”
- [ ] ë°°í¬ í›„ í…ŒìŠ¤íŠ¸
- [ ] Fallback ë™ì‘ í™•ì¸ (`[Session Fallback]` ë¡œê·¸)
- [ ] SMS ë²„í¼ë§ ë™ì‘ í™•ì¸ (`ë²„í¼ì—ì„œ SMS ì½”ë“œ ì‚¬ìš©` ë¡œê·¸)

---

## ğŸ“ ë©”ëª¨

### ìˆ˜ì •ëœ íŒŒì¼
```
relay-server/services/auto-reauth.js  - SMS ë²„í¼ë§ ë¡œì§ ì¶”ê°€
relay-server/server.js                - ì„¸ì…˜ Fallback ë¡œì§, ì´ë©”ì¼ ë°œì†¡ ìµœì í™”
```

### ì„¸ì…˜ ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ (ìµœì¢…)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Relay Server                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ DualSessionMgr  â”‚     â”‚    AutoReauthService        â”‚   â”‚
â”‚  â”‚ Primary/Backup  â”‚â—„â”€â”€â”€â”€â”‚    + SMS ë²„í¼ë§ (NEW!)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                 â”‚
â”‚           â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        getSessionFromRedis() + Fallback (NEW!)      â”‚   â”‚
â”‚  â”‚  ìš”ì²­ ì„¸ì…˜ ìœ íš¨? â†’ Yes â†’ ì‚¬ìš©                         â”‚   â”‚
â”‚  â”‚       â†“ No                                          â”‚   â”‚
â”‚  â”‚  í™œì„± ì„¸ì…˜ìœ¼ë¡œ ìë™ ì „í™˜ â†’ ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤!             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ì¡°ê±´ (ìµœì¢…)
```
1. ìë™ ì¬ì¸ì¦ ìµœì¢… ì‹¤íŒ¨ ì‹œ (reauthFailed ì´ë²¤íŠ¸)
2. Fallbackë„ ì‹¤íŒ¨í•˜ì—¬ ì„¸ì…˜ ì¡°íšŒ ë¶ˆê°€ ì‹œ (checkSessionValidity)
3. ì¤‘ë³µ ì•Œë¦¼ì€ 10ë¶„ ì¿¨ë‹¤ìš´ìœ¼ë¡œ ì–µì œ (mail-service)
```

### í…ŒìŠ¤íŠ¸ ë°©ë²•
```bash
# 1. ë°°í¬
aws ecs update-service --cluster vroong-cluster --service vroong-relay-service-dev --force-new-deployment --region ap-northeast-2

# 2. CloudWatchì—ì„œ ë¡œê·¸ í™•ì¸
fields @timestamp, @message
| filter @message like /Session Fallback|ë²„í¼ì—ì„œ SMS|reauthFailed/
| sort @timestamp desc
| limit 50
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- [[2026-02-12]] - ë“€ì–¼ ì„¸ì…˜ ë§¤ë‹ˆì € êµ¬í˜„, SMS ì›¹í›… ì„¤ì •
- [[2026-02-11]] - ìë™ ì¬ì¸ì¦ ì„œë¹„ìŠ¤ êµ¬í˜„
