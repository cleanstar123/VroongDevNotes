# 2026-02-11 ê°œë°œ ì¼ì§€

#daily #vroong #baemin #auto-reauth #bot-detection #n-plus-one #stored-procedure

---

## ğŸ“Š ì˜¤ëŠ˜ ì‘ì—… ìš”ì•½

| ì‘ì—… | ìƒíƒœ | ë¶„ë¥˜ |
| --- | :-: | --- |
| ë¼ì´ë” ì„ ì •ì‚° N+1 í˜„ìƒ ìˆ˜ì • | âœ… | Performance |
| sp_get_weekly_dashboard_all í”„ë¡œì‹œì € í™œìš© | âœ… | Optimization |
| SMS íƒ€ì´ë° ì´ìŠˆ ìˆ˜ì • | âœ… | Bug Fix |
| ì›Œë°ì—… ë‹¨ê³„ ì œê±° | âœ… | Refactor |
| ë´‡ íƒì§€ ë¬¸ì œ ë¶„ì„ | ğŸ”„ | Debug |

---

## 1. ë¼ì´ë” ì„ ì •ì‚° N+1 í˜„ìƒ ìˆ˜ì •

> [!info] ë°°ê²½
> - ë¼ì´ë” ì„ ì •ì‚°ë‚´ì—­ì—ì„œ í˜‘ë ¥ì‚¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œ ì„±ëŠ¥ ë¬¸ì œ ë°œìƒ
> - ê° ë¼ì´ë”ë§ˆë‹¤ í˜‘ë ¥ì‚¬ ì •ë³´ë¥¼ ê°œë³„ ì¿¼ë¦¬ë¡œ ì¡°íšŒí•˜ëŠ” N+1 ë¬¸ì œ

> [!warning] ë¬¸ì œ
> - í˜‘ë ¥ì‚¬ ëª©ë¡ ì¡°íšŒ ì‹œ N+1 ì¿¼ë¦¬ë¡œ ì¸í•œ ëŠë¦° ì‘ë‹µ ì†ë„
> - ë¼ì´ë” ìˆ˜ê°€ ë§ì„ìˆ˜ë¡ ì¿¼ë¦¬ ìˆ˜ê°€ ê¸‰ê²©íˆ ì¦ê°€

> [!success] í•´ê²°
> - SupplierRepositoryì— ì¼ê´„ ì¡°íšŒ ë©”ì„œë“œ ì¶”ê°€
> - FeeMstRepositoryImpl ìµœì í™”
> - RiderPreSettlementUseCase ì¿¼ë¦¬ ë¡œì§ ê°œì„ 
> - **ì»¤ë°‹**: `d39c730` - "ë¼ì´ë” ì„ ì •ì‚°ë‚´ì—­ì—ì„œ í˜‘ë ¥ì‚¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° N+1 í˜„ìƒì— ë”°ë¥¸ ëŠë¦¼í˜„ìƒ ìˆ˜ì •"

> [!tip] ë°°ìš´ ì 
> - JPAì—ì„œ ì—°ê´€ ì—”í‹°í‹° ì¡°íšŒ ì‹œ í•­ìƒ N+1 ê°€ëŠ¥ì„± í™•ì¸ í•„ìš”
> - ì¼ê´„ ì¡°íšŒ(Batch Fetch) ë˜ëŠ” Join Fetchë¡œ í•´ê²°

### ìˆ˜ì •ëœ íŒŒì¼ (7ê°œ)
```
api/src/main/java/com/vroong/api/app/controller/portal/settlement/RiderPreSettlementController.java
api/src/main/java/com/vroong/api/domain/portal/fee/repository/FeeMstRepository.java
api/src/main/java/com/vroong/api/domain/portal/fee/usecase/RiderFeeUseCase.java
api/src/main/java/com/vroong/api/domain/portal/partner/repository/SupplierRepository.java
api/src/main/java/com/vroong/api/domain/portal/settlement/usecase/RiderPreSettlementUseCase.java
api/src/main/java/com/vroong/api/infrastructure/persistence/repository/portal/fee/FeeMstRepositoryImpl.java
api/src/main/java/com/vroong/api/infrastructure/persistence/repository/portal/partner/SupplierRepositoryImpl.java
```

---

## 2. sp_get_weekly_dashboard_all í”„ë¡œì‹œì € í™œìš©

> [!info] ë°°ê²½
> - ëŒ€ì‹œë³´ë“œ ì£¼ê°„ ì„±ê³¼ ì¡°íšŒ ì‹œ ì—¬ëŸ¬ í”„ë¡œì‹œì € ê°œë³„ í˜¸ì¶œ
> - 4ê°œì˜ í”„ë¡œì‹œì €ë¥¼ ìˆœì°¨ í˜¸ì¶œí•˜ì—¬ ì„±ëŠ¥ ì €í•˜

> [!warning] ë¬¸ì œ
> - ê¸°ì¡´: 4ê°œ í”„ë¡œì‹œì € ê°œë³„ í˜¸ì¶œ
>   1. sp_get_weekly_daily_performance
>   2. sp_get_weekly_supplier_aggregation
>   3. sp_get_supplier_period_performance
>   4. sp_get_supplier_daily_slots

> [!success] í•´ê²°
> - í†µí•© í”„ë¡œì‹œì € `sp_get_weekly_dashboard_all` ìƒì„±/í™œìš©
> - 1íšŒ í˜¸ì¶œë¡œ 4ê°œ ê²°ê³¼ì…‹ ë°˜í™˜
> - `DashboardQueryDslRepository.loadWeeklyDashboardAll()` ë©”ì„œë“œë¡œ í˜¸ì¶œ
> - CallableStatementë¡œ Multiple ResultSet ì²˜ë¦¬

> [!tip] ë°°ìš´ ì 
> - MySQL í”„ë¡œì‹œì €ì—ì„œ Multiple ResultSet ë°˜í™˜ ê°€ëŠ¥
> - JDBC CallableStatementë¡œ ìˆœì°¨ì ìœ¼ë¡œ ê²°ê³¼ì…‹ ì²˜ë¦¬

### í”„ë¡œì‹œì € í˜¸ì¶œ ì½”ë“œ
```java
String sql = "{CALL sp_get_weekly_dashboard_all(?, ?, ?)}";
try (Connection conn = dataSource.getConnection();
     CallableStatement stmt = conn.prepareCall(sql)) {
    stmt.setString(1, fromDate);
    stmt.setString(2, toDate);
    stmt.setString(3, suppId);

    boolean hasResults = stmt.execute();
    int resultSetIndex = 0;

    while (hasResults || stmt.getUpdateCount() != -1) {
        if (hasResults) {
            try (ResultSet rs = stmt.getResultSet()) {
                switch (resultSetIndex) {
                    case 0 -> parseDailyPerformanceResultSet(rs, dailyDataList);
                    case 1 -> parseSupplierAggregationResultSet(rs, periodAggMap);
                    case 2 -> parseSupplierPeriodResultSet(rs, supplierPeriodMap);
                    case 3 -> parseSupplierDailySlotsResultSet(rs, supplierDailyMap);
                }
            }
            resultSetIndex++;
        }
        hasResults = stmt.getMoreResults();
    }
}
```

---

## 3. SMS íƒ€ì´ë° ì´ìŠˆ ìˆ˜ì •

> [!info] ë°°ê²½
> - ë°°ë¯¼ ìë™ ì¬ì¸ì¦ ì‹œ 2FA(SMS ì¸ì¦) í•„ìš”
> - MacroDroid â†’ AWS Backend â†’ Relay Serverë¡œ SMS ì›¹í›… ì „ë‹¬ êµ¬ì¡°
> - SMS ì½”ë“œê°€ ë„ì°©í•´ë„ ì¸ì¦ì´ ì§„í–‰ë˜ì§€ ì•ŠëŠ” ë¬¸ì œ ë°œìƒ

> [!warning] ë¬¸ì œ
> - ë¡œê·¸ ë¶„ì„ ê²°ê³¼: SMSê°€ `_waitForSMS()` í˜¸ì¶œ **ì „ì—** ë„ì°©
> - `request2FACode()` í˜¸ì¶œ â†’ SMS ì¦‰ì‹œ ë°œì†¡ â†’ SMS ë„ì°© â†’ `_waitForSMS()` í˜¸ì¶œ (ì´ë¯¸ ëŠ¦ìŒ)
> - ì—ëŸ¬ ë©”ì‹œì§€: "SMS ìˆ˜ì‹ í–ˆìœ¼ë‚˜ ëŒ€ê¸° ì¤‘ì¸ ì¬ì¸ì¦ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"

> [!success] í•´ê²°
> - `auto-reauth.js` ìˆ˜ì •: SMS ë¦¬ìŠ¤ë„ˆë¥¼ **ë¨¼ì €** ì„¤ì •í•œ í›„ 2FA ì½”ë“œ ìš”ì²­
> - ë³€ê²½ ì „:
>   ```javascript
>   await this.baeminService.request2FACode(session);  // SMS ë°œì†¡
>   const smsCode = await this._waitForSMS();  // ì´ë¯¸ ëŠ¦ìŒ!
>   ```
> - ë³€ê²½ í›„:
>   ```javascript
>   const smsPromise = this._waitForSMS();  // ë¨¼ì € ë¦¬ìŠ¤ë‹ ì‹œì‘
>   await this.baeminService.request2FACode(session);  // SMS ë°œì†¡
>   const smsCode = await smsPromise;  // ìºì¹˜ ì„±ê³µ
>   ```
> - `startReauth()` ë©”ì„œë“œì™€ `_completeReauth()` ë©”ì„œë“œ ëª¨ë‘ ìˆ˜ì •

> [!tip] ë°°ìš´ ì 
> - ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹œ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ìˆœì„œê°€ ì¤‘ìš”
> - ì›¹í›…ì²˜ëŸ¼ ì™¸ë¶€ì—ì„œ ë“¤ì–´ì˜¤ëŠ” ì´ë²¤íŠ¸ëŠ” ë°˜ë“œì‹œ ë¦¬ìŠ¤ë„ˆë¥¼ ë¨¼ì € ì„¤ì •í•´ì•¼ í•¨

---

## 4. ì›Œë°ì—… ë‹¨ê³„ ì œê±°

> [!info] ë°°ê²½
> - ê¸°ì¡´ ë¡œê·¸ì¸ íë¦„: www.baemin.com â†’ biz-member.baemin.com â†’ login í˜ì´ì§€
> - ë´‡ íƒì§€ ìš°íšŒë¥¼ ìœ„í•´ ì›Œë°ì—… ë‹¨ê³„ ì¶”ê°€í–ˆì—ˆìŒ

> [!warning] ë¬¸ì œ
> - ì˜¤íˆë ¤ ë³µì¡í•œ ì›Œë°ì—… íŒ¨í„´ì´ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í–‰ë™ìœ¼ë¡œ ê°ì§€ë¨
> - ì›Œë°ì—…ì— ì´ 20-30ì´ˆ ì†Œìš” â†’ ê·¸ í›„ì—ë„ "ë³´ì•ˆ ìœ„ë°° ì ‘ê·¼ ì œí•œ í˜ì´ì§€" ì°¨ë‹¨

> [!success] í•´ê²°
> - `auth.js`ì—ì„œ ì›Œë°ì—… ë¡œì§ ì „ì²´ ì œê±°
> - ë¡œê·¸ì¸ í˜ì´ì§€ ì§ì ‘ ì´ë™ìœ¼ë¡œ ë³€ê²½
> - ì‹¤ì œ ì‚¬ìš©ìë„ ë¶ë§ˆí¬/URL ì§ì ‘ ì…ë ¥ìœ¼ë¡œ ì ‘ê·¼í•˜ë¯€ë¡œ ë” ìì—°ìŠ¤ëŸ¬ì›€

> [!tip] ë°°ìš´ ì 
> - ë´‡ íƒì§€ ìš°íšŒ ì‹œ "ë” ë§ì€ ë™ì‘ = ë” ì•ˆì „"ì´ ì•„ë‹˜
> - ì˜¤íˆë ¤ ë‹¨ìˆœí•˜ê³  ì§ì ‘ì ì¸ ì ‘ê·¼ì´ ìì—°ìŠ¤ëŸ¬ìš¸ ìˆ˜ ìˆìŒ

---

## 5. ë´‡ íƒì§€ ë¬¸ì œ ë¶„ì„

> [!info] ë°°ê²½
> - ë°°ë¯¼ ë¡œê·¸ì¸ ì‹œë„ ì‹œ ì§€ì†ì ìœ¼ë¡œ ë´‡ íƒì§€ ì°¨ë‹¨ ë°œìƒ
> - í˜ì´ì§€ íƒ€ì´í‹€: "ë³´ì•ˆ ìœ„ë°° ì ‘ê·¼ ì œí•œ í˜ì´ì§€ 1"
> - í˜ì´ì§€ ë‚´ìš©: "ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¬ë°”ë¥´ì§€ ì•Šì€ ìš”ì²­ìœ¼ë¡œ í˜ì´ì§€ë¥¼ ë³´ì‹¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

> [!warning] ë¬¸ì œ
> - Cloudflare ChallengeëŠ” í†µê³¼í•˜ì§€ë§Œ ë°°ë¯¼ ìì²´ ë³´ì•ˆ ì‹œìŠ¤í…œì´ ì°¨ë‹¨
> - ì›Œë°ì—… ì œê±° í›„ì—ë„ ë™ì¼í•œ ì°¨ë‹¨ ë°œìƒ
> - ê°€ëŠ¥í•œ ì›ì¸:
>   1. ì„œë²„ IPê°€ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ë¨
>   2. Puppeteer ë¸Œë¼ìš°ì € í•‘ê±°í”„ë¦°íŠ¸ ê°ì§€
>   3. Incognito ëª¨ë“œë¡œ ë§¤ë²ˆ ìƒˆ ì„¸ì…˜ ìƒì„±ì´ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íŒ¨í„´

> [!success] í•´ê²°
> - í˜„ì¬ í•´ê²° ëŒ€ê¸° ì¤‘ (ì¼ì • ì‹œê°„ í›„ ì°¨ë‹¨ í•´ì œ ì˜ˆìƒ)
> - ëŒ€ì•ˆ:
>   1. 30ë¶„~1ì‹œê°„ í›„ ì¬ì‹œë„
>   2. ìˆ˜ë™ ë¡œê·¸ì¸ìœ¼ë¡œ ì„¸ì…˜ í™œì„±í™”
>   3. User Data ë””ë ‰í† ë¦¬ ì‚¬ìš© (Incognito ëŒ€ì‹  ì˜êµ¬ í”„ë¡œí•„)

> [!tip] ë°°ìš´ ì 
> - ë´‡ íƒì§€ëŠ” Cloudflare ì™¸ì— ì‚¬ì´íŠ¸ ìì²´ ë³´ì•ˆ ì‹œìŠ¤í…œë„ ì¡´ì¬
> - ì§§ì€ ì‹œê°„ ë‚´ ë°˜ë³µ ì‹œë„ëŠ” IP ì°¨ë‹¨ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŒ

---

## ğŸ“‹ TODO

- [ ] ì‹œê°„ ê²½ê³¼ í›„ ë´‡ íƒì§€ í•´ì œ ì—¬ë¶€ í…ŒìŠ¤íŠ¸
- [ ] SMS íƒ€ì´ë° ìˆ˜ì • í›„ 2FA ì¸ì¦ íë¦„ í…ŒìŠ¤íŠ¸
- [ ] í˜‘ë ¥ì‚¬ ëª©ë¡ ì¡°íšŒ ì„±ê³µ ì—¬ë¶€ í™•ì¸
- [ ] ë“€ì–¼ ì„¸ì…˜ ì •ìƒ ì‘ë™ í™•ì¸

---

## ğŸ“ ë©”ëª¨

### ì˜¤ëŠ˜ ì»¤ë°‹
- `d39c730` - ë¼ì´ë” ì„ ì •ì‚°ë‚´ì—­ì—ì„œ í˜‘ë ¥ì‚¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° N+1 í˜„ìƒì— ë”°ë¥¸ ëŠë¦¼í˜„ìƒ ìˆ˜ì •

### ìˆ˜ì •ëœ íŒŒì¼ (Relay Server)
- `relay-server/services/auto-reauth.js` - SMS íƒ€ì´ë° ìˆ˜ì • (2êµ°ë°)
- `relay-server/services/baemin/auth.js` - ì›Œë°ì—… ë¡œì§ ì œê±°

### ìˆ˜ì •ëœ íŒŒì¼ (API)
- `RiderPreSettlementController.java`
- `FeeMstRepository.java` / `FeeMstRepositoryImpl.java`
- `RiderFeeUseCase.java`
- `SupplierRepository.java` / `SupplierRepositoryImpl.java`
- `RiderPreSettlementUseCase.java`

### ê´€ë ¨ íŒŒì¼ (ì°¸ê³ )
- `relay-server/services/browser/core.js` - ë¸Œë¼ìš°ì € ê´€ë¦¬, ì•ˆí‹°ë””í…ì…˜
- `relay-server/services/browser/cloudflare.js` - Cloudflare ìš°íšŒ
- `relay-server/services/baemin/center.js` - í˜‘ë ¥ì‚¬ ëª©ë¡ ì¡°íšŒ
- `relay-server/services/dual-session-manager.js` - ë“€ì–¼ ì„¸ì…˜ ê´€ë¦¬
- `DashboardQueryDslRepository.java` - sp_get_weekly_dashboard_all í˜¸ì¶œ

### ë°°ë¯¼ ë¡œê·¸ì¸ íë¦„
```
1. ì„¸ì…˜ ìƒì„± (Incognito)
2. ë¡œê·¸ì¸ í˜ì´ì§€ ì´ë™ (Cloudflare ìš°íšŒ)
3. ID/PW ì…ë ¥ â†’ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
4. 2FA í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
5. "ì¸ì¦ë²ˆí˜¸ ë°›ê¸°" ë²„íŠ¼ í´ë¦­
6. SMS ì›¹í›… ìˆ˜ì‹  ëŒ€ê¸°
7. ì¸ì¦ì½”ë“œ ì…ë ¥ â†’ í™•ì¸
8. í˜‘ë ¥ì‚¬ ëª©ë¡ ì¡°íšŒë¡œ ì„¸ì…˜ í™œì„±í™”
```

### SMS ì›¹í›… íë¦„
```
MacroDroid (Android)
  â†’ AWS Backend (/webhook/sms)
  â†’ Relay Server (/webhook/sms)
  â†’ autoReauthService.receiveSMS()
  â†’ smsResolve(code)
```
