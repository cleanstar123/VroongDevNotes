# 주간보고서 2월 2주차
> 2026-02-10 (월) ~ 2026-02-14 (금)

---

## 요약

| 분류 | 완료 작업 수 |
|------|-------------|
| Backend | 12 |
| Frontend | 1 |
| Infra | 3 |
| Performance | 4 |
| Bug Fix | 5 |

---

## 주요 완료 작업

### 1. 배민 세션 자동 재인증 시스템 구축

**배경**
- 배민 셀러 세션 만료 시 수동으로 로그인 + 2FA SMS 인증 필요
- relay-server의 Puppeteer 자동 로그인은 구현되었으나 SMS 인증코드 입력이 수동

**해결**
- MacroDroid 앱으로 SMS 수신 시 자동으로 서버에 전달
- SMS 웹훅 엔드포인트 추가 (`GET /api/v1/baemin/auth/sms-webhook`)
- 세션 만료 → 자동 로그인 → SMS 수신 → MacroDroid 자동 전달 → 인증 완료

**성과**
- 58개 협력사 정상 조회 확인
- 수동 개입 없이 완전 자동화 달성

---

### 2. 듀얼 세션 매니저 구현 및 통합

**배경**
- 단일 세션 만료 시 배치 작업 중단 위험
- 무중단 서비스를 위한 백업 세션 필요

**해결**
- Primary/Backup 듀얼 세션 아키텍처 구현
- 세션 만료 감지 시 자동 Failover
- 세션 Fallback 로직 추가 (요청 세션 무효 시 활성 세션으로 자동 전환)
- SMS 버퍼링 로직 추가 (타이밍 이슈 해결)

**추가된 API 엔드포인트**
| 엔드포인트 | 설명 |
|-----------|------|
| `GET /relay/dual-session/status` | Primary/Backup 세션 상태 |
| `GET /relay/dual-session/active` | 현재 활성 세션 ID |
| `POST /relay/dual-session/start` | 듀얼 세션 시작 |
| `POST /relay/dual-session/failover` | 수동 페일오버 |
| `POST /relay/dual-session/stop` | 듀얼 세션 정지 |

---

### 3. ALB 인프라 구성 (8090 포트)

**배경**
- relay-server는 8090 포트 사용
- 기존 ALB는 8080(dev), 443(prod)만 리스닝

**해결**
- 타겟 그룹 생성: `vroong-relay-tg-dev` (Port: 8090)
- ALB 리스너 추가: HTTP 8090 → vroong-relay-tg-dev
- ECS 서비스에 타겟 그룹 연결
- 보안 그룹 설정 (ALB → ECS 8090 허용)
- ALB 가용 영역 추가 (2c, 2d)

---

### 4. AOP 기반 감사 로그 시스템 구현

**배경**
- 라이더 출금 시 일부 테이블 누락 케이스 발생
- 중요 비즈니스 로직에 대한 추적 로그 필요

**해결**
- Spring AOP 기반 `@AuditLog` 어노테이션 방식 구현
- CloudWatch Logs 자동 전송 (Fargate 환경)
- 민감정보 자동 마스킹 (계좌번호, 비밀번호 등)

**지원 카테고리**
| 분류 | 카테고리 |
|------|----------|
| 금융 | WITHDRAWAL, DEPOSIT, TRANSFER |
| 정산 | PRE_SETTLEMENT, WEEKLY_SETTLEMENT |
| 인증 | SIGNUP, LOGIN, LOGOUT, TOKEN_REFRESH |
| 외부API | HECTO_API, BAEMIN_API |
| 배치 | BAEMIN_DELIVERY_BATCH, BAEMIN_RIDER_BATCH |

---

### 5. 성능 최적화 (N+1 문제 해결)

**대시보드 프로시저 통합**
- 기존: 4개 프로시저 순차 호출
- 개선: `sp_get_weekly_dashboard_all` 1개로 통합
- Multiple Result Sets 방식으로 4개 결과셋 반환
- DB 호출 4회 → 1회로 감소

**본사 수수료 페이지 최적화**
- 기존: 173개 협력사 × 개별 수수료 조회 = 174번 DB 호출
- 개선: `sp_get_all_supplier_commissions` 통합 프로시저
- DB 호출 174회 → 1회로 감소

**라이더 선정산 목록 최적화**
- SupplierRepository에 일괄 조회 메서드 추가
- FeeMstRepositoryImpl 최적화
- RiderPreSettlementUseCase 쿼리 로직 개선

---

### 6. 기타 버그 수정 및 개선

| 작업 | 내용 |
|------|------|
| 라이더 출금제한 배치 로직 제거 | 앱에서 이미 처리하므로 중복 로직 제거 |
| 정산서 중복 업로드 에러 메시지 개선 | 모호한 메시지 → 구체적인 기간 표시 |
| 프론트엔드 에러 메시지 버그 수정 | axios 인터셉터 에러 객체 구조 처리 |
| 이메일 발송 로직 최적화 | 자동 재인증 최종 실패 시에만 발송 |

---

## 수정된 파일

**Backend (API)**
```
RiderPreSettlementController.java
FeeMstRepository.java / FeeMstRepositoryImpl.java
RiderFeeUseCase.java
SupplierRepository.java / SupplierRepositoryImpl.java
RiderPreSettlementUseCase.java
DashboardQueryDslRepository.java
NoticeUseCase.java
BatchWithdrawalUseCase.java
SettlementUploadUseCase.java
```

**Frontend**
```
useSettlementUpload.ts
```

**Relay Server**
```
server.js
services/auto-reauth.js
services/baemin/auth.js
services/baemin/constants.js
services/baemin/index.js
services/baemin/center.js
services/browser/core.js
services/dual-session-manager.js
```

**Infra / Logging**
```
infrastructure/logging/annotation/AuditLog.java
infrastructure/logging/aspect/AuditLogAspect.java
infrastructure/logging/model/AuditLogCategory.java
infrastructure/logging/model/AuditLogEntry.java
infrastructure/logging/service/AuditLogService.java
infrastructure/logging/util/SensitiveDataMasker.java
logback-spring.xml
```

---

## 다음 주 계획

- [ ] 듀얼 세션 Failover 동작 확인
- [ ] SMS 버퍼링 동작 확인
- [ ] 변경사항 테스트 완료 후 PR 생성
- [ ] 삭제 가능한 기존 프로시저 정리
