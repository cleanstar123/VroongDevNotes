# 주간 업무 보고서

---

## 2주차 (2026-02-10 ~ 2026-02-14)

### 요약

| 분류 | 완료 작업 수 |
|------|-------------|
| Backend | 12 |
| Frontend | 1 |
| Infra | 3 |
| Performance | 4 |
| Bug Fix | 5 |

---

### 주요 완료 작업

#### 1. 배민 세션 자동 재인증 시스템 구축

**배경**
- 배민 셀러 세션 만료 시 수동으로 로그인 + 2FA SMS 인증 필요
- relay-server의 Puppeteer 자동 로그인은 구현되었으나 SMS 인증코드 입력이 수동

**해결**
- MacroDroid 앱으로 SMS 수신 시 자동으로 서버에 전달
- SMS 웹훅 엔드포인트 추가 (`GET /api/v1/baemin/auth/sms-webhook`)
- 세션 만료 → 자동 로그인 → SMS 수신 → MacroDroid 자동 전달 → 인증 완료

**성과**
- 58개 협력사 정상 조회 확인
- 수동 개입 없이 완전 자동화 달성

---

#### 2. 듀얼 세션 매니저 구현 및 통합

**배경**
- 단일 세션 만료 시 배치 작업 중단 위험
- 무중단 서비스를 위한 백업 세션 필요

**해결**
- Primary/Backup 듀얼 세션 아키텍처 구현
- 세션 만료 감지 시 자동 Failover
- 세션 Fallback 로직 추가 (요청 세션 무효 시 활성 세션으로 자동 전환)
- SMS 버퍼링 로직 추가 (타이밍 이슈 해결)

**추가된 API 엔드포인트**
| 엔드포인트 | 설명 |
|-----------|------|
| `GET /relay/dual-session/status` | Primary/Backup 세션 상태 |
| `GET /relay/dual-session/active` | 현재 활성 세션 ID |
| `POST /relay/dual-session/start` | 듀얼 세션 시작 |
| `POST /relay/dual-session/failover` | 수동 페일오버 |
| `POST /relay/dual-session/stop` | 듀얼 세션 정지 |

---

#### 3. ALB 인프라 구성 (8090 포트)

**배경**
- relay-server는 8090 포트 사용
- 기존 ALB는 8080(dev), 443(prod)만 리스닝

**해결**
- 타겟 그룹 생성: `vroong-relay-tg-dev` (Port: 8090)
- ALB 리스너 추가: HTTP 8090 → vroong-relay-tg-dev
- ECS 서비스에 타겟 그룹 연결
- 보안 그룹 설정 (ALB → ECS 8090 허용)
- ALB 가용 영역 추가 (2c, 2d)

---

#### 4. AOP 기반 감사 로그 시스템 구현

**배경**
- 라이더 출금 시 일부 테이블 누락 케이스 발생
- 중요 비즈니스 로직에 대한 추적 로그 필요

**해결**
- Spring AOP 기반 `@AuditLog` 어노테이션 방식 구현
- CloudWatch Logs 자동 전송 (Fargate 환경)
- 민감정보 자동 마스킹 (계좌번호, 비밀번호 등)

**지원 카테고리**
| 분류 | 카테고리 |
|------|----------|
| 금융 | WITHDRAWAL, DEPOSIT, TRANSFER |
| 정산 | PRE_SETTLEMENT, WEEKLY_SETTLEMENT |
| 인증 | SIGNUP, LOGIN, LOGOUT, TOKEN_REFRESH |
| 외부API | HECTO_API, BAEMIN_API |
| 배치 | BAEMIN_DELIVERY_BATCH, BAEMIN_RIDER_BATCH |

---

#### 5. 성능 최적화 (N+1 문제 해결)

**대시보드 프로시저 통합**
- 기존: 4개 프로시저 순차 호출
- 개선: `sp_get_weekly_dashboard_all` 1개로 통합
- Multiple Result Sets 방식으로 4개 결과셋 반환
- DB 호출 4회 → 1회로 감소

**본사 수수료 페이지 최적화**
- 기존: 173개 협력사 × 개별 수수료 조회 = 174번 DB 호출
- 개선: `sp_get_all_supplier_commissions` 통합 프로시저
- DB 호출 174회 → 1회로 감소

**라이더 선정산 목록 최적화**
- SupplierRepository에 일괄 조회 메서드 추가
- FeeMstRepositoryImpl 최적화
- RiderPreSettlementUseCase 쿼리 로직 개선

---

#### 6. 기타 버그 수정 및 개선

| 작업 | 내용 |
|------|------|
| 라이더 출금제한 배치 로직 제거 | 앱에서 이미 처리하므로 중복 로직 제거 |
| 정산서 중복 업로드 에러 메시지 개선 | 모호한 메시지 → 구체적인 기간 표시 |
| 프론트엔드 에러 메시지 버그 수정 | axios 인터셉터 에러 객체 구조 처리 |
| 이메일 발송 로직 최적화 | 자동 재인증 최종 실패 시에만 발송 |

---

### 수정된 파일 (2주차)

**Backend (API)**
```
RiderPreSettlementController.java
FeeMstRepository.java / FeeMstRepositoryImpl.java
RiderFeeUseCase.java
SupplierRepository.java / SupplierRepositoryImpl.java
RiderPreSettlementUseCase.java
DashboardQueryDslRepository.java
NoticeUseCase.java
BatchWithdrawalUseCase.java
SettlementUploadUseCase.java
```

**Frontend**
```
useSettlementUpload.ts
```

**Relay Server**
```
server.js
services/auto-reauth.js
services/baemin/auth.js
services/baemin/constants.js
services/baemin/index.js
services/baemin/center.js
services/browser/core.js
services/dual-session-manager.js
```

**Infra**
```
infrastructure/logging/annotation/AuditLog.java
infrastructure/logging/aspect/AuditLogAspect.java
infrastructure/logging/model/AuditLogCategory.java
infrastructure/logging/model/AuditLogEntry.java
infrastructure/logging/service/AuditLogService.java
infrastructure/logging/util/SensitiveDataMasker.java
logback-spring.xml
```

---

## 3주차 (2026-02-17 ~ 2026-02-20)

### 요약

| 분류 | 완료 작업 수 |
|------|-------------|
| Backend | 4 |
| Bug Fix | 4 |

---

### 주요 완료 작업

#### 1. 라이더 주정산 일차감 표시 및 실지급 계산 로직 수정

**배경**
- 선정산에서 일차감 발생 시 주정산서에 해당 내역 미표시
- 선정산배달료(PRE_ACCT_VAL)는 **이미 일차감이 차감된 금액**

**문제**
1. 일차감 미표시: 선정산 라이더의 주정산 일차감이 0원으로 표시
2. 실지급배달료 계산 오류: 일차감 중복 차감 또는 미반영

**해결**
- **표시용**: `DEDUCT_AMT = totalDeductAmt` (전체 일차감 금액)
- **선정산배달료 복원**: `adjustedPreAcctVal = preAcctVal + preDeductVal`
- **실지급 계산**: `TOT_ACCT_VAL = finalDeliveryVal - adjustedPreAcctVal - actualDeductAmt`

**계산 예시 (na35176 라이더)**
| 항목 | 값 |
|------|-----|
| 최종배달료 | 395,046원 |
| 선정산배달료 | 235,423원 (일차감 차감 후) |
| 선정산 일차감 | 145,530원 |
| 선정산배달료(복원) | 380,953원 |
| **실지급배달료** | **14,093원** |

---

#### 2. DAILY 타입 공제 END_DAY 무시 버그 수정

**배경**
- 공제 기간: 2026-01-29 ~ 2026-02-16
- 정산 기간: 2026-02-11 ~ 2026-02-17
- 교집합: 2026-02-11 ~ 2026-02-16 (6일)

**문제**
- `calculateEffectiveDays()`가 계약 이력 기반 값(7일) 반환
- 공제 END_DAY가 무시되어 7일치 차감됨

**해결**
- 교집합 일수 직접 계산: `intersectionDays = ChronoUnit.DAYS.between(effectiveStart, effectiveEnd) + 1`
- 169,785원 (7일) → 145,530원 (6일) 정상 계산

---

#### 3. WORK_DAY 타입 공제 교집합 기간 적용

**배경**
- WORK_DAY 공제: 근무일에만 차감 (배송 완료 건이 있는 날)

**문제**
- 기존: 전체 정산 기간의 근무일수 사용
- 공제 기간이 정산 기간보다 짧아도 전체 근무일수로 계산됨

**해결**
- 교집합 기간에 대해 `countWorkDays()` 호출
- RiderSettlementUseCase.java 및 PartnerSettlementUseCase.java 모두 수정

```java
if ("WORK_DAY".equals(deductType)) {
    int intersectionWorkDays = vrDeliveryListQueryDslRepository.countWorkDays(
        supplyId, riderId,
        effectiveStart.format(DATE_FORMATTER),
        effectiveEnd.format(DATE_FORMATTER));
    totalDeduct = totalDeduct.add(deductAmt.multiply(BigDecimal.valueOf(intersectionWorkDays)));
}
```

---

### 일차감 계산 흐름 (최종)

```
1. 공제 기간 ∩ 정산 기간 = 교집합 기간 계산
2. DAILY: 교집합 일수 × 일차감 금액 = totalDeductAmt
3. WORK_DAY: 교집합 기간 내 근무일수 × 일차감 금액 = totalDeductAmt
4. preDeductVal = 선정산에서 이미 차감된 일차감 합계
5. actualDeductAmt = totalDeductAmt - preDeductVal (주정산에서 추가 차감할 금액)
6. adjustedPreAcctVal = preAcctVal + preDeductVal (선정산배달료 복원)
7. totAcctVal = finalDeliveryVal - adjustedPreAcctVal - actualDeductAmt
```

---

### 수정된 파일 (3주차)

```
RiderSettlementUseCase.java - 일차감 표시/계산 분리, 선정산배달료 복원, DAILY/WORK_DAY 교집합 적용
PartnerSettlementUseCase.java - WORK_DAY 교집합 기간 근무일수 조회
```

---

## 전체 요약

| 주차 | 주요 성과 |
|------|----------|
| 2주차 | 배민 세션 완전 자동화, 듀얼 세션 무중단 서비스, 감사 로그 시스템 구축, N+1 성능 최적화 |
| 3주차 | 라이더 주정산 일차감 로직 정상화, 공제 기간 교집합 계산 적용 |

---

## 다음 주 계획

- [ ] WORK_DAY 타입 공제 테스트 시나리오 작성
- [ ] 정산 기간과 공제 기간 교집합 없는 케이스 엣지 케이스 테스트
- [ ] 선정산 없는 라이더 일차감 정상 작동 확인
- [ ] 변경사항 테스트 완료 후 PR 생성
