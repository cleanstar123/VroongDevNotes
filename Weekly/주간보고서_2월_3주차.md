# 주간보고서 2월 3주차
> 2026-02-17 (월) ~ 2026-02-21 (금)

---

## 요약

| 분류 | 완료 작업 수 |
|------|-------------|
| Backend | 4 |
| Bug Fix | 4 |

---

## 주요 완료 작업

### 1. 라이더 주정산 일차감 표시 및 실지급 계산 로직 수정

**배경**
- 선정산에서 일차감 발생 시 주정산서에 해당 내역 미표시
- 선정산배달료(PRE_ACCT_VAL)는 **이미 일차감이 차감된 금액**

**문제**
1. 일차감 미표시: 선정산 라이더의 주정산 일차감이 0원으로 표시
2. 실지급배달료 계산 오류: 일차감 중복 차감 또는 미반영

**해결**
- **표시용**: `DEDUCT_AMT = totalDeductAmt` (전체 일차감 금액)
- **선정산배달료 복원**: `adjustedPreAcctVal = preAcctVal + preDeductVal`
- **실지급 계산**: `TOT_ACCT_VAL = finalDeliveryVal - adjustedPreAcctVal - actualDeductAmt`

**계산 예시 (na35176 라이더)**
| 항목 | 값 |
|------|-----|
| 최종배달료 | 395,046원 |
| 선정산배달료 | 235,423원 (일차감 차감 후) |
| 선정산 일차감 | 145,530원 |
| 선정산배달료(복원) | 380,953원 |
| **실지급배달료** | **14,093원** |

---

### 2. DAILY 타입 공제 END_DAY 무시 버그 수정

**배경**
- 공제 기간: 2026-01-29 ~ 2026-02-16
- 정산 기간: 2026-02-11 ~ 2026-02-17
- 교집합: 2026-02-11 ~ 2026-02-16 (6일)

**문제**
- `calculateEffectiveDays()`가 계약 이력 기반 값(7일) 반환
- 공제 END_DAY가 무시되어 7일치 차감됨

**해결**
- 교집합 일수 직접 계산
- `intersectionDays = ChronoUnit.DAYS.between(effectiveStart, effectiveEnd) + 1`
- 169,785원 (7일) → 145,530원 (6일) 정상 계산

---

### 3. WORK_DAY 타입 공제 교집합 기간 적용

**배경**
- WORK_DAY 공제: 근무일에만 차감 (배송 완료 건이 있는 날)

**문제**
- 기존: 전체 정산 기간의 근무일수 사용
- 공제 기간이 정산 기간보다 짧아도 전체 근무일수로 계산됨

**해결**
- 교집합 기간에 대해 `countWorkDays()` 호출
- RiderSettlementUseCase.java 및 PartnerSettlementUseCase.java 모두 수정

```java
if ("WORK_DAY".equals(deductType)) {
    int intersectionWorkDays = vrDeliveryListQueryDslRepository.countWorkDays(
        supplyId, riderId,
        effectiveStart.format(DATE_FORMATTER),
        effectiveEnd.format(DATE_FORMATTER));
    totalDeduct = totalDeduct.add(deductAmt.multiply(BigDecimal.valueOf(intersectionWorkDays)));
}
```

---

### 4. 협력사 정산 조회 기능 개선

**해결**
- PartnerSettlementController: 조회일자 범위(startDate, endDate) 기능 추가
- VrSupplierInfoQueryDslRepository: 협력사명, 대표자명, 사업자번호 조회 메서드 추가

---

## 일차감 계산 흐름 (최종 정리)

```
1. 공제 기간 ∩ 정산 기간 = 교집합 기간 계산
2. DAILY: 교집합 일수 × 일차감 금액 = totalDeductAmt
3. WORK_DAY: 교집합 기간 내 근무일수 × 일차감 금액 = totalDeductAmt
4. preDeductVal = 선정산에서 이미 차감된 일차감 합계
5. actualDeductAmt = totalDeductAmt - preDeductVal (주정산에서 추가 차감할 금액)
6. adjustedPreAcctVal = preAcctVal + preDeductVal (선정산배달료 복원)
7. totAcctVal = finalDeliveryVal - adjustedPreAcctVal - actualDeductAmt
```

**핵심 포인트**
> 선정산배달료(PRE_ACCT_VAL)는 이미 일차감이 차감된 금액이다.
> 따라서 실지급 계산 시 preDeductVal을 더해서 일차감 차감 전 금액으로 복원해야 함.

---

## 수정된 파일

```
RiderSettlementUseCase.java
 - 일차감 표시/계산 분리
 - 선정산배달료 복원 로직
 - DAILY/WORK_DAY 교집합 적용

PartnerSettlementUseCase.java
 - WORK_DAY 교집합 기간 근무일수 조회

PartnerSettlementController.java
 - 조회일자 범위 기능 추가

VrSupplierInfoQueryDslRepository.java
 - 협력사명, 대표자명, 사업자번호 조회 메서드 추가
```

---

## 다음 주 계획

- [ ] WORK_DAY 타입 공제 테스트 시나리오 작성
- [ ] 정산 기간과 공제 기간 교집합 없는 케이스 엣지 케이스 테스트
- [ ] 선정산 없는 라이더 일차감 정상 작동 확인
- [ ] 변경사항 테스트 완료 후 PR 생성
